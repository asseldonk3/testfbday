<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MVP News Trading System - Complete Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body { background: #f8f9fa; }
        .navbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .pipeline-card {
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            min-height: 180px;
        }
        .pipeline-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        .pipeline-card.active {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102,126,234,0.1) 0%, rgba(118,75,162,0.1) 100%);
        }
        .step-number {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .stats-card {
            border-left: 4px solid #667eea;
        }
        .activity-feed {
            max-height: 400px;
            overflow-y: auto;
        }
        .signal-badge {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .btn-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }
        .btn-gradient:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            color: white;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-graph-up"></i> MVP News Trading System
            </span>
            <div class="d-flex text-white">
                <span class="me-3"><i class="bi bi-clock"></i> <span id="market-status">Market Closed</span></span>
                <span><i class="bi bi-wallet2"></i> Portfolio: <span id="portfolio-value">$100,000</span></span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-3">
        <!-- Portfolio Stats Row -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="card stats-card">
                    <div class="card-body">
                        <h6 class="text-muted">Daily P&L</h6>
                        <h4 id="daily-pnl" class="text-success">+$0</h4>
                        <small class="text-muted">0.00%</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stats-card">
                    <div class="card-body">
                        <h6 class="text-muted">Open Positions</h6>
                        <h4 id="open-positions">0</h4>
                        <small class="text-muted">Max: 3</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stats-card">
                    <div class="card-body">
                        <h6 class="text-muted">Today's Trades</h6>
                        <h4 id="today-trades">0/3</h4>
                        <small class="text-muted">Limit: 3/day</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stats-card">
                    <div class="card-body">
                        <h6 class="text-muted">Win Rate</h6>
                        <h4 id="win-rate" class="text-primary">0%</h4>
                        <small class="text-muted">Target: >60%</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stats-card">
                    <div class="card-body">
                        <h6 class="text-muted">Risk Used</h6>
                        <h4 id="risk-used" class="text-warning">0%</h4>
                        <small class="text-muted">Max: 5%/day</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stats-card">
                    <div class="card-body">
                        <h6 class="text-muted">Active Signals</h6>
                        <h4 id="active-signals">0</h4>
                        <small class="text-muted signal-badge">‚óè Live</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trading Pipeline -->
        <div class="row mb-4">
            <div class="col-12">
                <h4 class="mb-3">üìä Trading Pipeline Status</h4>
                <div class="row g-3">
                    <!-- Step 0: Weekly Selection -->
                    <div class="col-md-3">
                        <div class="card pipeline-card" id="step-0" onclick="runWeeklySelection()">
                            <div class="card-body text-center">
                                <div class="step-number mx-auto">0</div>
                                <h6>Weekly Selection</h6>
                                <p class="small text-muted">Select 10-25 stocks</p>
                                <div id="watchlist-status">
                                    <span class="badge bg-warning">Not Selected</span>
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-gradient" onclick="runWeeklySelection(event)">
                                            <i class="bi bi-play-fill"></i> Run Selection
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 1: News Scout -->
                    <div class="col-md-3">
                        <div class="card pipeline-card" id="step-1">
                            <div class="card-body text-center">
                                <div class="step-number mx-auto">1</div>
                                <h6>News Scout</h6>
                                <p class="small text-muted">Monitor every 30min</p>
                                <div id="scout-status">
                                    <span class="badge bg-secondary">Waiting</span>
                                    <div class="small mt-2">Next: <span id="next-scan">--:--</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: AI Analysis -->
                    <div class="col-md-3">
                        <div class="card pipeline-card" id="step-2">
                            <div class="card-body text-center">
                                <div class="step-number mx-auto">2</div>
                                <h6>AI Analyst</h6>
                                <p class="small text-muted">Convert to signals</p>
                                <div id="analyst-status">
                                    <span class="badge bg-secondary">Idle</span>
                                    <div class="small mt-2">Signals: <span id="signal-count">0</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Risk Check -->
                    <div class="col-md-3">
                        <div class="card pipeline-card" id="step-3">
                            <div class="card-body text-center">
                                <div class="step-number mx-auto">3</div>
                                <h6>Risk Manager</h6>
                                <p class="small text-muted">Validate trades</p>
                                <div id="risk-status">
                                    <span class="badge bg-secondary">Ready</span>
                                    <div class="small mt-2">Approved: <span id="approved-count">0</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Position Sizing -->
                    <div class="col-md-3">
                        <div class="card pipeline-card" id="step-4">
                            <div class="card-body text-center">
                                <div class="step-number mx-auto">4</div>
                                <h6>Position Sizing</h6>
                                <p class="small text-muted">Calculate shares</p>
                                <div id="sizing-status">
                                    <span class="badge bg-secondary">Ready</span>
                                    <div class="small mt-2">Kelly: <span id="kelly-factor">0.25</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 5: Order Execution -->
                    <div class="col-md-3">
                        <div class="card pipeline-card" id="step-5">
                            <div class="card-body text-center">
                                <div class="step-number mx-auto">5</div>
                                <h6>Executor</h6>
                                <p class="small text-muted">Place orders</p>
                                <div id="executor-status">
                                    <span class="badge bg-secondary">Ready</span>
                                    <div class="small mt-2">Alpaca: <span class="text-success">‚óè</span> Connected</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 6: Position Monitor -->
                    <div class="col-md-3">
                        <div class="card pipeline-card" id="step-6">
                            <div class="card-body text-center">
                                <div class="step-number mx-auto">6</div>
                                <h6>Position Monitor</h6>
                                <p class="small text-muted">Track P&L</p>
                                <div id="monitor-status">
                                    <span class="badge bg-secondary">Monitoring</span>
                                    <div class="small mt-2">Active: <span id="active-positions">0</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 7: Exit Manager -->
                    <div class="col-md-3">
                        <div class="card pipeline-card" id="step-7">
                            <div class="card-body text-center">
                                <div class="step-number mx-auto">7</div>
                                <h6>Exit Manager</h6>
                                <p class="small text-muted">Stop loss/Take profit</p>
                                <div id="exit-status">
                                    <span class="badge bg-secondary">Ready</span>
                                    <div class="small mt-2">SL/TP Set: <span id="stops-set">0</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Row -->
        <div class="row">
            <!-- Watchlist -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="bi bi-eye"></i> Weekly Watchlist</h6>
                    </div>
                    <div class="card-body" style="height: 400px; overflow-y: auto;">
                        <div id="watchlist-stocks">
                            <p class="text-muted text-center">No stocks selected</p>
                            <p class="text-center">
                                <button class="btn btn-sm btn-outline-primary" onclick="runWeeklySelection()">
                                    Select Stocks
                                </button>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Active Signals -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0"><i class="bi bi-lightning"></i> Active Signals</h6>
                    </div>
                    <div class="card-body" style="height: 400px; overflow-y: auto;">
                        <div id="active-signals-list">
                            <p class="text-muted text-center">No active signals</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Trades -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0"><i class="bi bi-arrow-left-right"></i> Recent Trades</h6>
                    </div>
                    <div class="card-body" style="height: 400px; overflow-y: auto;">
                        <div id="recent-trades">
                            <p class="text-muted text-center">No trades today</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activity Feed -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h6 class="mb-0"><i class="bi bi-activity"></i> Live Activity</h6>
                    </div>
                    <div class="card-body activity-feed" style="height: 400px; overflow-y: auto;">
                        <div id="activity-feed">
                            <div class="small text-muted mb-2">
                                <span class="text-info">‚óè</span> System started
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <button class="btn btn-success w-100" onclick="startSystem()">
                                    <i class="bi bi-play-fill"></i> Start Trading
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-warning w-100" onclick="pauseSystem()">
                                    <i class="bi bi-pause-fill"></i> Pause System
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-info w-100" onclick="testWebhook()">
                                    <i class="bi bi-send"></i> Test Webhook
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-danger w-100" onclick="emergencyStop()">
                                    <i class="bi bi-stop-fill"></i> Emergency Stop
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let watchlist = [];
        let systemRunning = false;

        // Run weekly selection
        async function runWeeklySelection(event) {
            if (event) event.stopPropagation();
            
            updatePipelineStep(0, 'active', 'Selecting...');
            addActivity('Running weekly stock selection...');
            
            try {
                const response = await fetch('/api/weekly_candidates_supabase', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const text = await response.text();
                const data = JSON.parse(text);
                
                if (data.success) {
                    watchlist = data.candidates;
                    displayWatchlist(data.candidates);
                    updatePipelineStep(0, 'success', `${data.total_selected} Selected`);
                    addActivity(`‚úÖ Selected ${data.total_selected} stocks for week ${data.week}`);
                    
                    // Enable next steps
                    updatePipelineStep(1, 'ready', 'Ready');
                    
                    // Save to localStorage
                    localStorage.setItem('watchlist', JSON.stringify(watchlist));
                    localStorage.setItem('watchlist_week', data.week);
                }
            } catch (error) {
                console.error('Error:', error);
                updatePipelineStep(0, 'error', 'Failed');
                addActivity(`‚ùå Selection failed: ${error.message}`);
            }
        }

        // Display watchlist
        function displayWatchlist(stocks) {
            const container = document.getElementById('watchlist-stocks');
            if (!stocks || stocks.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No stocks selected</p>';
                return;
            }
            
            container.innerHTML = stocks.map((stock, i) => `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span><strong>${i+1}. ${stock.symbol}</strong></span>
                    <span class="badge bg-${stock.score >= 85 ? 'success' : stock.score >= 75 ? 'warning' : 'secondary'}">
                        ${stock.score}
                    </span>
                </div>
                <small class="text-muted d-block mb-2">${stock.reason}</small>
            `).join('');
        }

        // Update pipeline step status
        function updatePipelineStep(step, status, text) {
            const stepCard = document.getElementById(`step-${step}`);
            if (!stepCard) return;
            
            // Update card state
            stepCard.classList.remove('active', 'success', 'error');
            if (status === 'active') stepCard.classList.add('active');
            
            // Update status badge
            const statusElement = stepCard.querySelector('[id$="-status"] .badge');
            if (statusElement) {
                statusElement.className = 'badge';
                switch(status) {
                    case 'active':
                        statusElement.classList.add('bg-primary');
                        break;
                    case 'success':
                        statusElement.classList.add('bg-success');
                        break;
                    case 'error':
                        statusElement.classList.add('bg-danger');
                        break;
                    case 'ready':
                        statusElement.classList.add('bg-info');
                        break;
                    default:
                        statusElement.classList.add('bg-secondary');
                }
                statusElement.textContent = text;
            }
        }

        // Add activity to feed
        function addActivity(message) {
            const feed = document.getElementById('activity-feed');
            const time = new Date().toLocaleTimeString();
            const entry = `
                <div class="small mb-2">
                    <span class="text-muted">${time}</span>
                    <div>${message}</div>
                </div>
            `;
            feed.insertAdjacentHTML('afterbegin', entry);
            
            // Keep only last 50 entries
            while (feed.children.length > 50) {
                feed.removeChild(feed.lastChild);
            }
        }

        // System control functions
        function startSystem() {
            if (!watchlist || watchlist.length === 0) {
                alert('Please select weekly stocks first (Step 0)');
                return;
            }
            systemRunning = true;
            addActivity('üöÄ Trading system started');
            startNewsMonitoring();
        }

        function pauseSystem() {
            systemRunning = false;
            addActivity('‚è∏Ô∏è System paused');
        }

        function testWebhook() {
            addActivity('üìß Sending test webhook...');
            // Simulate webhook test
            setTimeout(() => {
                addActivity('‚úÖ Webhook test successful');
                updatePipelineStep(2, 'active', 'Processing');
            }, 1000);
        }

        function emergencyStop() {
            if (confirm('Are you sure? This will close all positions and stop trading.')) {
                systemRunning = false;
                addActivity('üõë EMERGENCY STOP ACTIVATED');
                // Reset all pipeline steps
                for (let i = 1; i <= 7; i++) {
                    updatePipelineStep(i, 'stopped', 'Stopped');
                }
            }
        }

        // Start news monitoring
        function startNewsMonitoring() {
            if (!systemRunning) return;
            
            updatePipelineStep(1, 'active', 'Scanning...');
            addActivity('üì∞ Scanning news sources...');
            
            // Simulate news monitoring every 30 seconds (in production: 30 minutes)
            setTimeout(() => {
                if (systemRunning) {
                    simulateNewsFound();
                }
            }, 30000);
        }

        // Simulate news found
        function simulateNewsFound() {
            const randomStock = watchlist[Math.floor(Math.random() * watchlist.length)];
            if (randomStock) {
                addActivity(`üì∞ News found for ${randomStock.symbol}`);
                updatePipelineStep(1, 'success', 'News Found');
                analyzeNews(randomStock);
            }
            
            // Continue monitoring
            if (systemRunning) {
                setTimeout(() => startNewsMonitoring(), 5000);
            }
        }

        // Analyze news
        function analyzeNews(stock) {
            updatePipelineStep(2, 'active', 'Analyzing...');
            
            setTimeout(() => {
                const confidence = Math.random();
                if (confidence > 0.7) {
                    addActivity(`üéØ Signal generated for ${stock.symbol} (${(confidence * 100).toFixed(0)}% confidence)`);
                    updatePipelineStep(2, 'success', 'Signal Created');
                    checkRisk(stock, confidence);
                } else {
                    addActivity(`‚ÑπÔ∏è News for ${stock.symbol} not actionable`);
                    updatePipelineStep(2, 'ready', 'Ready');
                }
            }, 2000);
        }

        // Risk check
        function checkRisk(stock, confidence) {
            updatePipelineStep(3, 'active', 'Checking...');
            
            setTimeout(() => {
                const approved = Math.random() > 0.3; // 70% approval rate
                if (approved) {
                    addActivity(`‚úÖ Risk approved for ${stock.symbol}`);
                    updatePipelineStep(3, 'success', 'Approved');
                    calculatePosition(stock, confidence);
                } else {
                    addActivity(`‚ùå Risk rejected for ${stock.symbol} (limits exceeded)`);
                    updatePipelineStep(3, 'error', 'Rejected');
                }
            }, 1500);
        }

        // Calculate position size
        function calculatePosition(stock, confidence) {
            updatePipelineStep(4, 'active', 'Calculating...');
            
            setTimeout(() => {
                const shares = Math.floor(Math.random() * 100) + 10;
                addActivity(`üìä Position size: ${shares} shares of ${stock.symbol}`);
                updatePipelineStep(4, 'success', 'Sized');
                executeTrade(stock, shares);
            }, 1000);
        }

        // Execute trade
        function executeTrade(stock, shares) {
            updatePipelineStep(5, 'active', 'Executing...');
            
            setTimeout(() => {
                addActivity(`üí∞ BUY ${shares} ${stock.symbol} @ Market`);
                updatePipelineStep(5, 'success', 'Executed');
                
                // Update stats
                const positions = parseInt(document.getElementById('open-positions').textContent) + 1;
                document.getElementById('open-positions').textContent = positions;
                
                // Start monitoring
                monitorPosition(stock, shares);
            }, 2000);
        }

        // Monitor position
        function monitorPosition(stock, shares) {
            updatePipelineStep(6, 'active', 'Monitoring');
            updatePipelineStep(7, 'ready', 'SL/TP Set');
            
            // Add to recent trades
            const tradesDiv = document.getElementById('recent-trades');
            tradesDiv.innerHTML = `
                <div class="small mb-2">
                    <strong>${stock.symbol}</strong> - ${shares} shares
                    <div class="text-success">Entry: Market</div>
                    <div class="text-muted">SL: -2% | TP: +5%</div>
                </div>
            ` + tradesDiv.innerHTML;
        }

        // Update market status
        function updateMarketStatus() {
            const now = new Date();
            const hours = now.getHours();
            const day = now.getDay();
            
            // Check if market is open (simplified)
            const isWeekday = day >= 1 && day <= 5;
            const isMarketHours = hours >= 9 && hours < 16;
            
            const statusElement = document.getElementById('market-status');
            if (isWeekday && isMarketHours) {
                statusElement.textContent = 'Market Open';
                statusElement.className = 'text-success';
            } else {
                statusElement.textContent = 'Market Closed';
                statusElement.className = 'text-danger';
            }
        }

        // Load saved watchlist on page load
        window.onload = function() {
            const savedWatchlist = localStorage.getItem('watchlist');
            if (savedWatchlist) {
                watchlist = JSON.parse(savedWatchlist);
                displayWatchlist(watchlist);
                updatePipelineStep(0, 'success', `${watchlist.length} Selected`);
                updatePipelineStep(1, 'ready', 'Ready');
            }
            
            updateMarketStatus();
            setInterval(updateMarketStatus, 60000); // Update every minute
            
            addActivity('üîå System initialized');
            addActivity('üí° Click Step 0 to select weekly stocks');
        };
    </script>
</body>
</html>